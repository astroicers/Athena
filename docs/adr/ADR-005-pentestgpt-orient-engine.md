# [ADR-005]: PentestGPT 整合為 Orient 引擎

| 欄位 | 內容 |
|------|------|
| **狀態** | `Accepted` |
| **日期** | 2026-02-23 |
| **決策者** | 專案負責人 |

---

## 背景（Context）

Athena OODA 循環的 Orient 階段是平台核心價值所在——將態勢資料轉化為可行動的戰術建議。Phase 5.1 需實作 `orient_engine.py`，整合 AI 情報分析能力。

需求：
- 分析當前作戰態勢（已完成技術、失敗原因、環境狀態）
- 產生 3 個戰術選項，每個附帶 MITRE ATT&CK 技術映射、推理說明、風險評估
- 推薦最佳路徑，並建議使用 Caldera 或 Shannon 執行
- 為指揮官提供可質疑、可理解的建議（非黑箱決策）

---

## 評估選項（Options Considered）

### 選項 A：PentestGPT（MIT）+ Claude API（主要）+ GPT-4（備用）

PentestGPT 作為整合框架，後端接 Claude 或 GPT-4 LLM API。

- **優點**：
  - MIT 授權，可安全直接 `import`（無授權污染風險）
  - PentestGPT 已內建滲透測試知識結構與提示工程
  - Claude 200K 上下文可容納完整作戰歷史 + MITRE 技術庫
  - 雙 LLM 容錯（Claude 不可用時自動降級至 GPT-4）
  - 輸出結構化（可直接映射至 `PentestGPTRecommendation` 模型）
- **缺點**：依賴外部 LLM API；每次 Orient 呼叫產生 API 成本（~$0.02-0.05）
- **風險**：LLM API 回應延遲（2-5 秒）可能影響 OODA 循環節奏

### 選項 B：自建提示工程（不使用 PentestGPT）

直接透過 LangChain / 原生 API 呼叫 Claude/GPT-4。

- **優點**：無第三方依賴；完全控制提示模板
- **缺點**：需從零建立滲透測試知識結構；PentestGPT 已解決的提示工程問題需重新發明
- **風險**：開發時間大幅增加，且品質可能不及 PentestGPT 已迭代的提示

### 選項 C：本地 LLM（Ollama + Llama 3 / Mistral）

- **優點**：無 API 成本、離線可用、資料不離開本機
- **缺點**：推理品質遠遜 Claude/GPT-4；7B/13B 模型無法可靠地產生結構化 MITRE 映射；需 GPU
- **風險**：戰術分析品質不足以展示「軍事顧問級」的核心價值主張

---

## 決策（Decision）

我們選擇 **選項 A：PentestGPT + Claude（主要）+ GPT-4（備用）**，因為：

1. **PentestGPT 是核心差異化**——它使 Athena 從「自動化工具」提升為「智慧指揮平台」
2. **MIT 授權安全**——可直接 `from pentestgpt import ...` 無授權風險
3. **Claude 推理能力**——200K 上下文 + 卓越推理，適合複雜多步驟戰術分析
4. **雙 LLM 容錯**——API 不可用時自動降級，確保 Demo 穩定性

整合架構：

```
orient_engine.py
├── 接收：Facts + OODAIteration（來自 fact_collector）
├── 呼叫：PentestGPT → Claude API（或 GPT-4 fallback）
├── 輸出：PentestGPTRecommendation
│   ├── situation_assessment: str
│   ├── options: List[TacticalOption]  (3 個)
│   │   ├── technique_id: str           (e.g. "T1003.001")
│   │   ├── technique_name: str         (e.g. "LSASS Memory")
│   │   ├── reasoning: str
│   │   ├── risk_level: RiskLevel
│   │   ├── recommended_engine: ExecutionEngine
│   │   ├── confidence: float           (0.0 - 1.0)
│   │   └── prerequisites: list[str]
│   ├── recommended_technique_id: str
│   └── confidence: float               (0.0 - 1.0)
└── 推送：WebSocket "recommendation" 事件
```

---

## 後果（Consequences）

**正面影響：**

- Orient 輸出結構化且可解釋——指揮官可質疑「為什麼推薦 T1003.001 而非 T1110？」
- 3 個選項設計迫使 AI 考量多種方案，避免單一路徑偏差
- confidence 分數協助 Decide 階段判斷是否需要人工介入
- PentestGPT 社群持續迭代提示工程，Athena 可受益於上游改進

**負面影響 / 技術債：**

- PentestGPT 版本鎖定——上游 breaking change 可能影響 Athena（需 pin 版本）
- LLM API 離線測試需建立 mock 層（返回預錄的 `PentestGPTRecommendation`）
- 每次 OODA Orient 呼叫 ~$0.02-0.05，連續快速迭代可能累積成本

**後續追蹤：**

- [ ] Phase 2：建立 `PentestGPTRecommendation` + `TacticalOption` Pydantic 模型
- [ ] Phase 5.1：實作 `orient_engine.py` 含 Claude/GPT-4 雙後端切換
- [ ] Phase 5：建立 LLM mock 層（`MOCK_LLM=true` 環境變數控制）
- [ ] Phase 6：Demo 場景中展示 Orient 產生 3 個選項的完整流程

---

## 關聯（Relations）

- 取代：（無）
- 被取代：（無）
- 參考：ADR-001（Claude 為主要 LLM）、ADR-003（Orient 在 OODA 引擎中的位置）、ADR-004（confidence 分數驅動自動化判斷）、ADR-006（recommended_engine 欄位供執行引擎路由）
